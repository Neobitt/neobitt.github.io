import{initializeApp}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore,collection,addDoc,orderBy,query,onSnapshot,doc,updateDoc,increment,where}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";if("file:"===window.location.protocol)console.error("❌ Error: Los módulos ES no funcionan en file://"),alert("Error: Esta página debe ejecutarse en un servidor HTTP/HTTPS.");else{try{const a={apiKey:"AIzaSyDp7VT6HMYBgqnrYfc84Tk9kh82nCBTYtM",authDomain:"dpccrea-login.firebaseapp.com",projectId:"dpccrea-login",appId:"1:822726011803:web:6b8f3e6a9d8c7b2e8f4e5d"},b=initializeApp(a),c=getFirestore(b),d=collection(c,"comentarios"),e=document.getElementById("commentForm"),f=document.getElementById("nameInput"),g=document.getElementById("messageInput"),h=document.getElementById("commentsList"),i=document.getElementById("errorMessage"),j=["idiota","estúpido","tonto","maldito","imbécil","grosero"],k=JSON.parse(localStorage.getItem("dpccrea_user"))||{};k.username?(f.value=k.username,f.disabled=!0):(f.value="",f.disabled=!0,e.querySelector("button").disabled=!0,i.textContent="Debes configurar tu nombre en el perfil para comentar.",i.style.display="block");const l=(a,b,c=20)=>new Promise(d=>{let e=0,f=setInterval(()=>{e<b.length?(a.textContent+=b.charAt(e),e++):(clearInterval(f),d())},c)}),m=a=>a.toLowerCase().includes(j.some(b=>a.toLowerCase().includes(b))),n=a=>{let b=document.createElement("div");b.className="notification",b.style.cssText="position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.95); border: 2px solid var(--neon-cyan); color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 0 20px var(--neon-cyan), 0 0 10px var(--inclusive-purple); font-family: 'Courier New', monospace; animation: notifIn 0.5s ease-out; pointer-events: auto;",b.innerHTML=`<strong style="color: var(--neon-cyan);"><i class="fas fa-bell"></i> Nuevo comentario</strong><p style="margin: 8px 0; color: var(--golden-accent); font-size: 0.9rem;">${a}</p>`,document.body.appendChild(b);let c=document.createElement("style");c.textContent="@keyframes notifIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes notifOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}",document.head.appendChild(c),setTimeout(()=>{b.style.animation="notifOut 0.5s ease-out",setTimeout(()=>{b.parentElement&&document.body.removeChild(b)},500)},5e3)},o=()=>{let a=new Audio("https://assets.codepen.io/3011180/notification-sound-1.mp3");a.volume=.3,a.play().catch(b=>console.error("❌ Error al reproducir sonido:",b))};const p=()=>{const a=query(d,orderBy("timestamp","desc")),b=new Set;onSnapshot(a,a=>{if(0===b.size)a.forEach(a=>b.add(a.id)),q(a);else{a.docChanges().forEach(c=>{"added"===c.type&&c.doc&&c.doc.data&&c.doc.data().name!==k.username&&b.add(c.doc.id)&&(n(`${c.doc.data().name||"Usuario"}: "${(c.doc.data().message||"").length>50?(c.doc.data().message||"").substring(0,47)+"...":c.doc.data().message||""}"`),o())}),q(a)}},a=>{(console.error("❌ Error al cargar comentarios:",a),i.textContent="Error al cargar comentarios: "+a.message,i.style.display="block")})},q=a=>{h.innerHTML="",a.empty?(a=document.createElement("p"),a.style.color="var(--golden-accent)",a.style.textAlign="center",a.textContent="No hay comentarios aún. ¡Sé el primero!",h.appendChild(a)):a.forEach(a=>{if(a.data().parentId)return;let b=a.data(),c=b.timestamp?.toDate().toLocaleDateString("es-ES")||"Fecha desconocida",d=b.name||"Usuario",e=b.message||"",f=b.likes||0,g=["L_Adriano","SalchiHot"].includes(d),i=b.photoURL||"https://via.placeholder.com/50",j=document.createElement("div");j.className="comment",j.innerHTML=`<div class="comment-header"><img src="${i}" alt="Foto de Perfil"><span class="name">${d}</span>${g?'<span class="creator-badge">[Creador]</span>':""}</div><div class="comment-body"></div><div class="comment-footer"><span class="date">${c}</span><span class="like-btn" data-id="${a.id}"><i class="far fa-heart"></i> ${f}</span><span class="reply-btn" data-id="${a.id}">Responder</span><span class="show-replies-btn" data-id="${a.id}" style="display: none;">Ver respuestas</span></div><div class="reply-form" data-id="${a.id}"><form><textarea class="form-control" placeholder="Escribe tu respuesta..." maxlength="500" rows="2"></textarea><button type="submit" class="btn">Enviar Respuesta</button></form></div><div class="replies" data-id="${a.id}"></div>`,h.appendChild(j),l(j.querySelector(".comment-body"),e,10).then(()=>{const b=query(d,where("parentId","==",a.id),orderBy("timestamp","desc"));onSnapshot(b,b=>{const c=j.querySelector(`.replies[data-id="${a.id}"]`),d=j.querySelector(`.show-replies-btn[data-id="${a.id}"]`);c.innerHTML="",b.empty?d.style.display="none":(d.style.display="inline",d.textContent=`Ver respuestas (${b.size})`,b.forEach(async b=>{let d=b.data(),e=d.timestamp?.toDate().toLocaleDateString("es-ES")||"Fecha desconocida",f=d.name||"Usuario",g=d.message||"",h=d.likes||0,i=["L_Adriano","SalchiHot"].includes(f),k=d.photoURL||"https://via.placeholder.com/50",l=document.createElement("div");l.className="comment reply",l.innerHTML=`<div class="comment-header"><img src="${k}" alt="Foto de Perfil"><span class="name">${f}</span>${i?'<span class="creator-badge">[Creador]</span>':""}</div><div class="comment-body"></div><div class="comment-footer"><span class="date">${e}</span><span class="like-btn" data-id="${b.id}"><i class="far fa-heart"></i> ${h}</span></div>`,c.appendChild(l),await l(l.querySelector(".comment-body"),g,10)}),a=>{(console.error("❌ Error al cargar respuestas:",a),i.textContent="Error al cargar respuestas: "+a.message,i.style.display="block")})})})};e.addEventListener("submit",async a=>{a.preventDefault(),i.style.display="none";const b=k.username,c=g.value.trim();if(!b)return i.textContent="Debes configurar tu nombre en el perfil para comentar.",void(i.style.display="block");if(c.length<3)return i.textContent="El mensaje debe tener al menos 3 caracteres.",void(i.style.display="block");if(m(c))return i.textContent="Por favor, evita usar malas palabras.",void(i.style.display="block");try{const a=k.photoURL||"https://via.placeholder.com/50";await addDoc(d,{name:b,message:c,timestamp:new Date,likes:0,photoURL:a}),g.value="",console.log("%c💬 Comentario enviado:","color: #DAA520",b)}catch(a){console.error("❌ Error al enviar comentario:",a),i.textContent="Error al enviar el comentario: "+a.message,i.style.display="block"}}),h.addEventListener("click",async a=>{const b=a.target.closest(".like-btn, .reply-btn, .show-replies-btn");if(!b)return;const c=b.dataset.id,d=document.querySelector(`.reply-form[data-id="${c}"]`);if(b.classList.contains("like-btn")&&(!d||!d.classList.contains("active")))b.classList.toggle("liked"),b.querySelector("i").classList.toggle("fas",b.classList.contains("liked")),b.querySelector("i").classList.toggle("far",!b.classList.contains("liked")),await updateDoc(doc(c,"comentarios",c),{likes:increment(b.classList.contains("liked")?1:-1)}).catch(a=>{(console.error("❌ Error al actualizar like:",a),i.textContent="Error al dar like: "+a.message,i.style.display="block")}),console.log("%c❤️ Like actualizado","color: #FF0000");else if(b.classList.contains("reply-btn"))d.classList.toggle("active"),d.classList.contains("active")&&d.querySelector("textarea").focus();else if(b.classList.contains("show-replies-btn")){const a=document.querySelector(`.replies[data-id="${c}"]`);a.classList.toggle("active"),a.children.length,b.textContent=a.classList.contains("active")?"Ocultar respuestas":`Ver respuestas (${a.children.length})`}}),h.addEventListener("submit",async a=>{a.preventDefault();const b=a.target.closest(".reply-form form");if(!b)return;const c=b.parentElement.dataset.id,e=b.querySelector("textarea").value.trim();if(!k.username)return i.textContent="Debes configurar tu nombre en el perfil para responder.",void(i.style.display="block");if(e.length<3)return i.textContent="La respuesta debe tener al menos 3 caracteres.",void(i.style.display="block");if(m(e))return i.textContent="Por favor, evita usar malas palabras.",void(i.style.display="block");try{const a=k.photoURL||"https://via.placeholder.com/50";await addDoc(d,{name:k.username,message:e,timestamp:new Date,likes:0,photoURL:a,parentId:c}),b.querySelector("textarea").value="",b.parentElement.classList.remove("active"),console.log("%c💬 Respuesta enviada:","color: #DAA520")}catch(a){console.error("❌ Error al enviar respuesta:",a),i.textContent="Error al enviar la respuesta: "+a.message,i.style.display="block"}}),p()}catch(a){console.error("❌ Error al inicializar Firebase:",a),alert("No se pudo inicializar Firebase: "+a.message+". Verifica la configuración o la conexión.")}}